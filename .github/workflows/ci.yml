name: "ci"

on:
  push:
    branches-ignore: [ main ]

concurrency:
  group: "ci-${{ github.ref }}"
  cancel-in-progress: true

jobs:

  ci:

    runs-on: ubuntu-latest

    steps:

#region Setup

    - uses: actions/checkout@v3

#endregion

#region Build and test assembly

    - uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x
    - run: dotnet restore ${{ vars.SLN_PATH }}
    - run: dotnet build ${{ vars.SLN_PATH }} --configuration Debug --no-restore
    - run: dotnet test ${{ vars.SLN_PATH }} --no-restore --verbosity normal

#endregion

#region Lint all XML files

    - uses: tecolicom/actions-use-apt-tools@v1
      with:
        tools: libxml2-utils
    - uses: tj-actions/glob@v17
      id: glob
      with:
        files: "**/*.xml"
    - run: xmllint --noout ${{ steps.glob.outputs.paths }}

#endregion

#region Upload artifact

    - id: get-short-sha
      run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - uses: actions/upload-artifact@v3
      with:
        name: "${{ vars.MOD_NAME }}-${{ steps.get-short-sha.outputs.short_sha }}"
        path: |
          *
          !.*

#endregion
